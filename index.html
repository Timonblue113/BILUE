<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra c·ª©u SKU ‚Äî Online & Offline</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- Camera Scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f5f7f8;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"],input[type="file"],button{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{background:#0ea5a4;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#64748b}
    #message{color:#334155;margin-left:8px;font-size:13px}
    #table-holder{margin-top:8px}
    @media(max-width:720px){.controls{flex-direction:column;align-items:stretch}}
    .hint{font-size:13px;color:#566574;margin-top:6px}
    .del-btn{background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 8px;cursor:pointer}
    .del-btn:hover{background:#b91c1c}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Qu·∫£n l√Ω & Tra c·ª©u SKU ‚Äî Online/Offline</h1>

  <audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <div class="controls">
      <input id="searchBox" type="text" placeholder="Nh·∫≠p SKU / T√™n h√†ng / Nh√£n hi·ªáu..." style="min-width:300px" />
      <input id="barcodeBox" type="text" placeholder="üßæ Qu√©t barcode 7 / 13 s·ªë..." style="min-width:220px" />

      <button id="searchBtn" class="secondary">üîç</button>
      <button id="camScanBtn">üì∑ Camera</button>

      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <button id="loadFileBtn">N·∫°p file</button>

      <button id="addRowBtn" class="secondary">‚ûï Th√™m d√≤ng</button>
      <button id="clearTableBtn" class="secondary">üßπ X√≥a b·∫£ng</button>
      <button id="downloadXLSXBtn">‚¨á Xu·∫•t Excel</button>

      <div id="message">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</div>
  </div>

  <div id="camera-area" style="display:none;margin-top:12px;">
      <div id="camera-view" style="width:100%;max-width:400px;height:300px;border:2px solid #0ea5a4;"></div>
      <button id="closeCamBtn" style="margin-top:8px;">ƒê√≥ng Camera</button>
  </div>

  <div id="table-holder" style="margin-top:12px; display:none;">
      <div id="sku-table"></div>
  </div>
</div>

<script>
/* ====== DELETE BUTTON ====== */
function deleteIcon(){return "<button class='del-btn'>X√≥a</button>";}
function deleteRow(e,cell){
  const row = cell.getRow();
  const index = displayedData.indexOf(row.getData());
  if(index > -1){
    displayedData.splice(index,1);
    row.delete();
    refreshSTT();
    showMessage("üóë ƒê√£ x√≥a 1 d√≤ng.");
  }
}

/* ====== DEFAULT COLUMNS ====== */
const defaultColumns=[
  {title:"STT", formatter:"rownum", width:60, hozAlign:"center"},
  {title:"üóë", formatter:deleteIcon, width:60, hozAlign:"center", headerSort:false, cellClick:deleteRow},

  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},

  {title:"UPC", field:"UPC", editor:"input"},  // üî• NEW UPC COLUMN

  {title:"Nh√£n Hi·ªáu", field:"NhanHieu", editor:"input"},
  {title:"T√™n H√†ng", field:"TenHang", editor:"input", width:300},
  {title:"M√¥ T·∫£", field:"MoTa", editor:"input", width:250},
  {title:"Quy C√°ch", field:"QuyCach", editor:"input"},
  {title:"Gi√° B√°n", field:"GiaBan", editor:"input"},
  {title:"Gi√° G·ªëc", field:"GiaGoc", editor:"input"},
  {title:"Qu√† T·∫∑ng", field:"QuaTang", editor:"input"},
  {title:"√Åp D·ª•ng", field:"ApDung", editor:"input"},
  {title:"Ng√†y Nh·∫≠p", field:"NgayNhap", editor:"input"}
];

let table=new Tabulator("#sku-table",{
  height:"520px",
  data:[],
  layout:"fitColumns",
  reactiveData:true,
  columns:defaultColumns,
  placeholder:"ƒêang n·∫°p d·ªØ li·ªáu...",
  cellEdited:()=>sourceData=table.getData()
});

let sourceData=[];
let displayedData=[];

/* ====== HELPER ====== */
function playBeep(){
  const snd=document.getElementById("beepSound");
  snd.currentTime=0;
  snd.play();
}
function showMessage(msg,isError=false){
  const el=document.getElementById("message");
  el.textContent=msg;
  el.style.color=isError?"#b91c1c":"#334155";
}
function refreshSTT(){ table.redraw(true); }

/* ====== SET DATA ====== */
function setTableData(arr){
  sourceData = arr.map(r=>({ ...r }));
  table.setData(sourceData);
  displayedData=[];
  document.getElementById("table-holder").style.display="block";
  showMessage("‚úÖ ƒê√£ t·∫£i " + arr.length + " d√≤ng t·ª´ Google Sheets!");
}

/* ====== LOAD GOOGLE SHEETS ====== */
function loadFromGoogleSheet(){
  const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pub?output=csv";
  showMessage("üîÑ ƒêang t·∫£i d·ªØ li·ªáu...");
  fetch(sheetURL)
    .then(r=>r.text())
    .then(txt=>{
      const wb=XLSX.read(txt,{type:"string"});
      const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
      setTableData(data);
    })
    .catch(err=>showMessage("‚ùå L·ªói t·∫£i Sheets: "+err,true));
}

/* ====== AUTO SEARCH UPC ‚Üí SKU ‚Üí OTHER ====== */
function barcodeSearch(code){
  const val = String(code).trim(); // GI·ªÆ S·ªê 0 ƒê·∫¶U

  if (!val) return;

  // ∆ØU TI√äN 1 ‚Äî UPC
  let filtered = sourceData.filter(r => String(r["UPC"]||"").trim() === val);

  // ∆ØU TI√äN 2 ‚Äî SKU
  if (!filtered.length)
    filtered = sourceData.filter(r => String(r["SKU"]||"").trim() === val);

  // CU·ªêI C√ôNG ‚Äî T√¨m m·ªù to√†n b·∫£ng
  if (!filtered.length){
    const fields = ["TenHang","NhanHieu","MoTa","QuyCach"];
    filtered = sourceData.filter(r =>
      fields.some(f => String(r[f]||"").toLowerCase().includes(val.toLowerCase()))
    );
  }

  if(filtered.length){
    displayedData = displayedData.concat(filtered);
    table.setData(displayedData);
    document.getElementById("table-holder").style.display="block";
    refreshSTT();
    playBeep();
    showMessage("üîé T√¨m th·∫•y " + filtered.length + " d√≤ng.");
  }else{
    showMessage("‚ùå Kh√¥ng t√¨m th·∫•y m√£: " + val,true);
  }
}

/* ====== INPUT BARCODE FIELD ====== */
document.getElementById('barcodeBox').addEventListener('input', e=>{
  const v = e.target.value.replace(/\D/g,""); // ch·ªâ l·∫•y s·ªë
  e.target.value = v;

  if (v.length === 7 || v.length === 13){
    barcodeSearch(v);
    e.target.value = "";
  }
});

/* ====== CAMERA SCAN ====== */
document.getElementById("camScanBtn").addEventListener("click",()=>{
  document.getElementById("camera-area").style.display="block";

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector('#camera-view'),
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader","ean_13_reader"]}
  }, err=>{
    if(err){ showMessage("L·ªói camera: "+err,true); return; }
    Quagga.start();
  });

  Quagga.onDetected(data=>{
    const code = data.codeResult.code;
    playBeep();
    barcodeSearch(code);
    Quagga.stop();
    document.getElementById("camera-area").style.display="none";
  });
});

document.getElementById("closeCamBtn").addEventListener("click",()=>{
  Quagga.stop();
  document.getElementById("camera-area").style.display="none";
});

/* ====== N√öT ====== */
document.getElementById('searchBtn').addEventListener('click',()=>{
  barcodeSearch(document.getElementById('searchBox').value);
});

document.getElementById('loadFileBtn').addEventListener('click',()=>{
  const f=document.getElementById('fileInput').files[0];
  if(!f) loadFromGoogleSheet(); 
  else loadFile(f);
});

/* ====== AUTO LOAD ====== */
window.addEventListener('DOMContentLoaded',loadFromGoogleSheet);
</script>

</body>
</html>
