<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u SKU & UPC</title>

<!-- Tabulator -->
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f5f7f8;margin:0;padding:18px}
.wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
input[type="text"],input[type="file"],button{padding:8px;border-radius:6px;border:1px solid #ccc}
button{background:#0ea5a4;color:#fff;border:0;cursor:pointer}
button.secondary{background:#64748b}
#message{color:#334155;margin-left:8px;font-size:13px}
#table-holder{margin-top:8px}
#video-container{margin-top:12px; display:none; position:relative; width:100%; max-width:400px;}
video{width:100%; border:2px solid #ccc; border-radius:10px;}
#video-container.success video{border-color:#22c55e;}
@media(max-width:720px){.controls{flex-direction:column;align-items:stretch}}
.hint{font-size:13px;color:#566574;margin-top:6px}
.del-btn{background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 8px;cursor:pointer}
.del-btn:hover{background:#b91c1c}
</style>
</head>
<body>

<div class="wrap">
<h1>Qu·∫£n l√Ω & Tra c·ª©u SKU ‚Äî Online/Offline</h1>

<div class="controls">
  <input id="searchBox" type="text" placeholder="Nh·∫≠p SKU / T√™n h√†ng / Nh√£n hi·ªáu..." style="min-width:300px" />
  <button id="searchBtn" class="secondary">üîç T√¨m ki·∫øm</button>
  <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
  <button id="loadFileBtn">N·∫°p file</button>
  <button id="addRowBtn" class="secondary">‚ûï Th√™m d√≤ng</button>
  <button id="clearTableBtn" class="secondary">üßπ X√≥a b·∫£ng</button>
  <button id="downloadXLSXBtn">‚¨á Xu·∫•t Excel</button>
  <button id="scanUPCBtn" class="secondary">üì∑ Qu√©t UPC</button>
  <div id="message">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</div>
</div>

<div class="hint">
  1) Web t·ª± n·∫°p d·ªØ li·ªáu Google Sheets khi m·ªü trang ‚Üí<br>
  2) Nh·∫≠p t·ª´ kh√≥a & Enter ƒë·ªÉ t√¨m (c·ªông d·ªìn, cho ph√©p SKU tr√πng) ‚Üí<br>
  3) S·ª≠a, th√™m d√≤ng, ho·∫∑c üóë x√≥a d√≤ng sai ‚Üí<br>
  4) Qu√©t UPC b·∫±ng camera, xu·∫•t Excel ho·∫∑c X√≥a b·∫£ng ƒë·ªÉ t·∫£i l·∫°i.
</div>

<div id="table-holder" style="margin-top:12px; display:none;">
  <div id="sku-table"></div>
</div>

<div id="video-container">
  <video id="video" autoplay muted playsinline></video>
  <button id="closeVideoBtn" style="position:absolute;top:5px;right:5px;padding:4px 8px;">‚úñ</button>
</div>
</div>

<script>
/* ====== Tabulator setup ====== */
const defaultColumns=[
  {title:"STT", formatter:"rownum", width:60, hozAlign:"center"},
  {title:"üóë", formatter:()=>"<button class='del-btn'>X√≥a</button>", width:60, hozAlign:"center", headerSort:false, cellClick:(e,cell)=>{ const row=cell.getRow(); row.delete(); }},
  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},
  {title:"Nh√£n Hi·ªáu", field:"NhanHieu", editor:"input"},
  {title:"T√™n H√†ng", field:"TenHang", editor:"input", width:300},
  {title:"M√¥ T·∫£", field:"MoTa", editor:"input", width:250},
  {title:"Quy C√°ch", field:"QuyCach", editor:"input"},
  {title:"Gi√° B√°n", field:"GiaBan", editor:"input"},
  {title:"Gi√° G·ªëc", field:"GiaGoc", editor:"input"},
  {title:"Qu√† T·∫∑ng", field:"QuaTang", editor:"input"},
  {title:"√Åp D·ª•ng", field:"ApDung", editor:"input"},
  {title:"Ng√†y Nh·∫≠p", field:"NgayNhap", editor:"input"},
  {title:"UPC", field:"UPC", editor:"input"}
];

let table=new Tabulator("#sku-table",{ height:"520px", data:[], layout:"fitColumns", reactiveData:true, columns:defaultColumns });
let sourceData=[]; let displayedData=[];

/* ====== Google Sheet load ====== */
function loadFromGoogleSheet(){
  const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pub?output=csv";
  fetch(sheetURL)
    .then(r=>r.text())
    .then(txt=>{
      const wb=XLSX.read(txt,{type:"string"});
      const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
      sourceData=data;
      table.setData(data); document.getElementById('table-holder').style.display='block';
      document.getElementById('message').textContent="‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets!";
    })
    .catch(err=>{document.getElementById('message').textContent="‚ùå L·ªói t·∫£i Google Sheets";});
}

window.addEventListener('DOMContentLoaded', loadFromGoogleSheet);

/* ====== Search ====== */
document.getElementById('searchBtn').addEventListener('click',()=>{ const q=document.getElementById('searchBox').value.trim().toLowerCase(); if(!q) return; const f=sourceData.filter(r=>Object.values(r).some(v=>String(v||'').toLowerCase().includes(q))); if(f.length){displayedData=f; table.setData(displayedData);} });
document.getElementById('searchBox').addEventListener('keydown',e=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById('searchBtn').click(); } });

/* ====== File load ====== */
document.getElementById('loadFileBtn').addEventListener('click',()=>{
  const f=document.getElementById('fileInput').files[0]; if(!f) loadFromGoogleSheet();
  else { const reader=new FileReader(); reader.onload=e=>{ const wb=XLSX.read(e.target.result,{type:f.name.endsWith(".csv")?"string":"array"}); const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""}); sourceData=data; table.setData(data);} ; f.name.endsWith(".csv")?reader.readAsText(f,"utf-8"):reader.readAsArrayBuffer(f); }
});

/* ====== Scan UPC ====== */
let codeReader=new ZXing.BrowserMultiFormatReader();
let scanning=false;
const video=document.getElementById('video');
const videoContainer=document.getElementById('video-container');

document.getElementById('scanUPCBtn').addEventListener('click',()=>{ startScan(); });
document.getElementById('closeVideoBtn').addEventListener('click',()=>{ stopScan(); });

function startScan(){
  if(scanning) return;
  scanning=true; videoContainer.style.display='block'; videoContainer.classList.remove('success');
  ZXing.BrowserMultiFormatReader.listVideoInputDevices().then(devices=>{
    const rear = devices.find(d=>d.label.toLowerCase().includes('back')) || devices[0];
    codeReader.decodeFromVideoDevice(rear.deviceId, video, (result, err)=>{
      if(result){
        const upc=result.text.trim();
        const found=sourceData.find(r=>r.UPC==upc || r.SKU==upc);
        if(found){
          displayedData=[found]; table.setData(displayedData);
          videoContainer.classList.add('success');
          new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play();
          document.getElementById('message').textContent="üì¶ ƒê√£ t√¨m th·∫•y m√£: "+upc;
        }
      }
    });
  }).catch(err=>{document.getElementById('message').textContent="‚ùå L·ªói camera"; scanning=false; });
}

function stopScan(){
  codeReader.reset(); scanning=false; videoContainer.style.display='none'; videoContainer.classList.remove('success');
}

</script>
</body>
</html>
