<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cá»©u SKU â€” Online & Offline</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f5f7f8;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"],input[type="file"],button{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{background:#0ea5a4;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#64748b}
    #message{color:#334155;margin-left:8px;font-size:13px}
    #table-holder{margin-top:8px}
    @media(max-width:720px){.controls{flex-direction:column;align-items:stretch}}
    .hint{font-size:13px;color:#566574;margin-top:6px}
    .del-btn{background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 8px;cursor:pointer}
    .del-btn:hover{background:#b91c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Quáº£n lÃ½ & Tra cá»©u SKU â€” Online/Offline</h1>

    <div class="controls">
      <input id="searchBox" type="text" placeholder="Nháº­p SKU / TÃªn hÃ ng / NhÃ£n hiá»‡u..." style="min-width:300px" />
      <button id="searchBtn" class="secondary">ğŸ” TÃ¬m kiáº¿m</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <button id="loadFileBtn">Náº¡p file</button>
      <button id="addRowBtn" class="secondary">â• ThÃªm dÃ²ng</button>
      <button id="clearTableBtn" class="secondary">ğŸ§¹ XÃ³a báº£ng</button>
      <button id="downloadXLSXBtn">â¬‡ Xuáº¥t Excel</button>
      <div id="message">Äang táº£i dá»¯ liá»‡u tá»« Google Sheets...</div>
    </div>

    <div class="hint">
      1) Web tá»± náº¡p dá»¯ liá»‡u Google Sheets khi má»Ÿ trang â†’
      2) Nháº­p tá»« khÃ³a & Enter Ä‘á»ƒ tÃ¬m (cá»™ng dá»“n, cho phÃ©p SKU trÃ¹ng) â†’
      3) Sá»­a, thÃªm dÃ²ng, hoáº·c ğŸ—‘ xÃ³a dÃ²ng sai â†’
      4) Xuáº¥t Excel hoáº·c XÃ³a báº£ng Ä‘á»ƒ táº£i láº¡i.
    </div>

    <div id="table-holder" style="margin-top:12px; display:none;">
      <div id="sku-table"></div>
    </div>
  </div>

<script>
/* ====== Cáº¥u hÃ¬nh báº£ng ====== */
const defaultColumns = [
  {title:"ğŸ—‘", formatter:deleteIcon, width:60, hozAlign:"center", headerSort:false, cellClick:deleteRow},
  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},
  {title:"NhÃ£n Hiá»‡u", field:"NhanHieu", editor:"input"},
  {title:"TÃªn HÃ ng", field:"TenHang", editor:"input", width:300},
  {title:"MÃ´ Táº£", field:"MoTa", editor:"input", width:250},
  {title:"Quy CÃ¡ch", field:"QuyCach", editor:"input"},
  {title:"GiÃ¡ BÃ¡n", field:"GiaBan", editor:"input"},
  {title:"GiÃ¡ Gá»‘c", field:"GiaGoc", editor:"input"},
  {title:"QuÃ  Táº·ng", field:"QuaTang", editor:"input"},
  {title:"Ãp Dá»¥ng", field:"ApDung", editor:"input"},
  {title:"NgÃ y Nháº­p", field:"NgayNhap", editor:"input"}
];

let table = new Tabulator("#sku-table", {
  height:"520px",
  data:[],
  layout:"fitColumns",
  reactiveData:true,
  columns: defaultColumns,
  placeholder:"Äang náº¡p dá»¯ liá»‡u...",
  cellEdited:()=> sourceData = table.getData(),
});

let sourceData = [];
let currentColumns = defaultColumns.map(c=>c.field);
let displayedData = [];

/* ====== Formatter & Event cho nÃºt XÃ³a dÃ²ng ====== */
function deleteIcon(){
  return "<button class='del-btn'>XÃ³a</button>";
}
function deleteRow(e, cell){
  const row = cell.getRow();
  const index = displayedData.indexOf(row.getData());
  if(index > -1){
    displayedData.splice(index, 1);
    row.delete();
    showMessage("ğŸ—‘ ÄÃ£ xÃ³a 1 dÃ²ng khá»i báº£ng hiá»ƒn thá»‹.");
  }
}

/* ====== Há»— trá»£ ====== */
function normalizeKey(k){ return String(k||'').trim(); }
function setTableColumnsFromKeys(keys){
  const cols = [{title:"ğŸ—‘", formatter:deleteIcon, width:60, hozAlign:"center", headerSort:false, cellClick:deleteRow}]
    .concat(keys.map(k=>({title:k, field:k, editor:"input"})));
  table.setColumns(cols);
  currentColumns = keys.slice();
}
function showMessage(msg,isError=false){
  const el=document.getElementById('message');
  el.textContent=msg;
  el.style.color=isError?"#b91c1c":"#334155";
}

/* ====== Náº¡p dá»¯ liá»‡u ====== */
function setTableData(arr){
  sourceData = arr.map(r=>{
    const out={};
    Object.keys(r).forEach(k=> out[normalizeKey(k)] = r[k]==null ? '' : String(r[k]));
    return out;
  });
  const keys = sourceData.length ? Object.keys(sourceData[0]) : currentColumns;
  setTableColumnsFromKeys(keys);
  table.clearData();
  displayedData=[];
  table.setData(sourceData);
  document.getElementById('table-holder').style.display='block';
  showMessage("âœ… ÄÃ£ táº£i "+arr.length+" dÃ²ng tá»« Google Sheets â€” sáºµn sÃ ng tra cá»©u!");
}

/* ====== Äá»c file Excel hoáº·c CSV ====== */
function loadFile(file){
  const reader=new FileReader();
  const name=(file.name||'').toLowerCase();
  reader.onload=function(e){
    try{
      let arr;
      if(name.endsWith(".csv")){
        arr=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:"string"}).Sheets[XLSX.read(e.target.result,{type:"string"}).SheetNames[0]],{defval:""});
      }else{
        const wb=XLSX.read(e.target.result,{type:"array"});
        arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
      }
      setTableData(arr);
    }catch(err){
      console.error(err);
      showMessage("Lá»—i khi Ä‘á»c file: "+err.message,true);
    }
  };
  if(name.endsWith(".csv")) reader.readAsText(file,"utf-8");
  else reader.readAsArrayBuffer(file);
}

/* ====== Náº¡p dá»¯ liá»‡u tá»« Google Sheets ====== */
function loadFromGoogleSheet(){
  const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pub?output=csv"; // ğŸ‘‰ Thay báº±ng link CSV tháº­t
  showMessage("ğŸ”„ Äang táº£i dá»¯ liá»‡u tá»« Google Sheets...");
  fetch(sheetURL)
    .then(r=>r.text())
    .then(txt=>{
      const data=XLSX.utils.sheet_to_json(XLSX.read(txt,{type:"string"}).Sheets[XLSX.read(txt,{type:"string"}).SheetNames[0]],{defval:""});
      setTableData(data);
    })
    .catch(err=>showMessage("âŒ Lá»—i táº£i Google Sheets: "+err,true));
}

/* ====== TÃ¬m kiáº¿m (cho phÃ©p SKU trÃ¹ng) ====== */
function doSearch(){
  const q=document.getElementById('searchBox').value.trim().toLowerCase();
  if(!sourceData.length){showMessage("ChÆ°a cÃ³ dá»¯ liá»‡u!",true);return;}
  if(!q){showMessage("Ã” tÃ¬m kiáº¿m trá»‘ng â€” giá»¯ nguyÃªn dá»¯ liá»‡u hiá»‡n cÃ³.");return;}
  const filtered=sourceData.filter(row=>Object.values(row).some(v=>String(v||'').toLowerCase().includes(q)));
  if(filtered.length){
    displayedData=displayedData.concat(filtered);
    table.setData(displayedData);
    document.getElementById('table-holder').style.display='block';
    showMessage("ÄÃ£ thÃªm "+filtered.length+" dÃ²ng (tá»•ng: "+displayedData.length+")");
  }else showMessage("KhÃ´ng tÃ¬m tháº¥y SKU nÃ o khá»›p '"+q+"'",true);
  document.getElementById('searchBox').value="";
}

/* ====== NÃºt chá»©c nÄƒng ====== */
document.getElementById('loadFileBtn').addEventListener('click',()=>{
  const f=document.getElementById('fileInput').files[0];
  if(!f) loadFromGoogleSheet(); else loadFile(f);
});
document.getElementById('searchBtn').addEventListener('click',doSearch);
document.getElementById('searchBox').addEventListener('keydown',e=>{
  if(e.key==="Enter"){e.preventDefault();doSearch();}
});
document.getElementById('addRowBtn').addEventListener('click',()=>{
  const empty={};(currentColumns.length?currentColumns:defaultColumns.map(c=>c.field)).forEach(k=>empty[k]='');
  table.addRow(empty,true).then(row=>{
    displayedData.push(empty);
    sourceData.push(empty);
    showMessage("ÄÃ£ thÃªm dÃ²ng má»›i. Nháº­p dá»¯ liá»‡u vÃ  Enter Ä‘á»ƒ lÆ°u.");
    row.getCell(currentColumns[0])?.edit(true);
  });
  document.getElementById('table-holder').style.display='block';
});
document.getElementById('clearTableBtn').addEventListener('click',()=>{
  table.clearData();
  displayedData=[];
  showMessage("ğŸ§¹ ÄÃ£ xÃ³a báº£ng. Äang táº£i láº¡i dá»¯ liá»‡u gá»‘c...");
  setTimeout(loadFromGoogleSheet,600);
});

/* ====== ğŸ“˜ Xuáº¥t Excel (.xlsx) ====== */
document.getElementById('downloadXLSXBtn').addEventListener('click',()=>{
  displayedData=table.getData();
  if(!displayedData.length){showMessage("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ táº£i",true);return;}
  const ws = XLSX.utils.json_to_sheet(displayedData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, "BKM_export.xlsx");
  showMessage("âœ… ÄÃ£ xuáº¥t file Excel thÃ nh cÃ´ng!");
});

/* ====== ğŸ”„ Tá»± Ä‘á»™ng load khi má»Ÿ trang ====== */
window.addEventListener('DOMContentLoaded', loadFromGoogleSheet);
</script>
</body>
</html>
