<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra c·ª©u SKU ‚Äî Online & Offline</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- ZXing Browser -->
  <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f5f7f8;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"],input[type="file"],button{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{background:#0ea5a4;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#64748b}
    #message{color:#334155;margin-left:8px;font-size:13px}
    #table-holder{margin-top:8px}
    @media(max-width:720px){.controls{flex-direction:column;align-items:stretch}}
    .hint{font-size:13px;color:#566574;margin-top:6px}
    .del-btn{background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 8px;cursor:pointer}
    .del-btn:hover{background:#b91c1c}
    #scannerModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:999}
    #scannerContainer{position:relative;width:90%;max-width:500px;background:#fff;padding:10px;border-radius:8px}
    #video{width:100%;border:2px solid #ccc;border-radius:6px}
    #closeScanner{position:absolute;top:5px;right:5px;background:#dc2626;color:#fff;border:none;border-radius:5px;padding:4px 8px;cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Qu·∫£n l√Ω & Tra c·ª©u SKU ‚Äî Online/Offline</h1>

  <div class="controls">
    <input id="searchBox" type="text" placeholder="Nh·∫≠p SKU / T√™n h√†ng / Nh√£n hi·ªáu..." style="min-width:300px" />
    <button id="searchBtn" class="secondary">üîç T√¨m ki·∫øm</button>
    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
    <button id="loadFileBtn">N·∫°p file</button>
    <button id="addRowBtn" class="secondary">‚ûï Th√™m d√≤ng</button>
    <button id="clearTableBtn" class="secondary">üßπ X√≥a b·∫£ng</button>
    <button id="downloadXLSXBtn">‚¨á Xu·∫•t Excel</button>
    <button id="scanUPCBtn" class="secondary">üì∑ Qu√©t UPC</button>
    <div id="message">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</div>
  </div>

  <div class="hint">
    1) Web t·ª± n·∫°p d·ªØ li·ªáu Google Sheets khi m·ªü trang ‚Üí<br>
    2) Nh·∫≠p t·ª´ kh√≥a & Enter ƒë·ªÉ t√¨m (c·ªông d·ªìn, cho ph√©p SKU tr√πng) ‚Üí<br>
    3) S·ª≠a, th√™m d√≤ng, ho·∫∑c üóë x√≥a d√≤ng sai ‚Üí<br>
    4) Xu·∫•t Excel ho·∫∑c X√≥a b·∫£ng ƒë·ªÉ t·∫£i l·∫°i.
  </div>

  <div id="table-holder" style="margin-top:12px; display:none;">
    <div id="sku-table"></div>
  </div>
</div>

<!-- Scanner Modal -->
<div id="scannerModal">
  <div id="scannerContainer">
    <button id="closeScanner">ƒê√≥ng</button>
    <video id="video" autoplay muted playsinline></video>
  </div>
</div>

<script>
/* ====== Tabulator setup ====== */
function deleteIcon(){return "<button class='del-btn'>X√≥a</button>";}
function deleteRow(e,cell){
  const row=cell.getRow();
  const index=displayedData.indexOf(row.getData());
  if(index>-1){
    displayedData.splice(index,1);
    row.delete();
    refreshSTT();
    showMessage("üóë ƒê√£ x√≥a 1 d√≤ng kh·ªèi b·∫£ng hi·ªÉn th·ªã.");
  }
}
const defaultColumns=[
  {title:"STT", formatter:"rownum", width:60, hozAlign:"center"},
  {title:"üóë", formatter:deleteIcon, width:60, hozAlign:"center", headerSort:false, cellClick:deleteRow},
  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},
  {title:"Nh√£n Hi·ªáu", field:"NhanHieu", editor:"input"},
  {title:"T√™n H√†ng", field:"TenHang", editor:"input", width:300},
  {title:"M√¥ T·∫£", field:"MoTa", editor:"input", width:250},
  {title:"Quy C√°ch", field:"QuyCach", editor:"input"},
  {title:"Gi√° B√°n", field:"GiaBan", editor:"input"},
  {title:"Gi√° G·ªëc", field:"GiaGoc", editor:"input"},
  {title:"Qu√† T·∫∑ng", field:"QuaTang", editor:"input"},
  {title:"√Åp D·ª•ng", field:"ApDung", editor:"input"},
  {title:"Ng√†y Nh·∫≠p", field:"NgayNhap", editor:"input"},
  {title:"UPC", field:"UPC", editor:"input"} // th√™m c·ªôt UPC cu·ªëi
];

let table=new Tabulator("#sku-table",{height:"520px",data:[],layout:"fitColumns",reactiveData:true,columns:defaultColumns,placeholder:"ƒêang n·∫°p d·ªØ li·ªáu...",cellEdited:()=>sourceData=table.getData()});
let sourceData=[],displayedData=[],currentColumns=defaultColumns.map(c=>c.field);
function normalizeKey(k){return String(k||'').trim();}
function showMessage(msg,isError=false){const el=document.getElementById('message');el.textContent=msg;el.style.color=isError?"#b91c1c":"#334155";}
function refreshSTT(){table.redraw(true);}
function setTableData(arr){sourceData=arr.map(r=>{const out={};Object.keys(r).forEach(k=>out[normalizeKey(k)]=r[k]==null?"":String(r[k]));return out;});table.clearData();displayedData=[];table.setData(sourceData);document.getElementById('table-holder').style.display='block';showMessage("‚úÖ ƒê√£ t·∫£i "+arr.length+" d√≤ng t·ª´ Google Sheets ‚Äî s·∫µn s√†ng tra c·ª©u!");}

/* ====== Load Google Sheet ====== */
function loadFromGoogleSheet(){
  const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pub?output=csv";
  showMessage("üîÑ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...");
  fetch(sheetURL)
    .then(r=>r.text())
    .then(txt=>{
      const wb=XLSX.read(txt,{type:"string"});
      const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
      setTableData(data);
    })
    .catch(err=>showMessage("‚ùå L·ªói t·∫£i Google Sheets: "+err,true));
}

/* ====== Load file ====== */
function loadFile(file){
  const reader=new FileReader();
  const name=(file.name||'').toLowerCase();
  reader.onload=function(e){
    try{
      let arr;
      if(name.endsWith(".csv")){const wb=XLSX.read(e.target.result,{type:"string"});arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});}
      else{const wb=XLSX.read(e.target.result,{type:"array"});arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});}
      setTableData(arr);
    }catch(err){showMessage("L·ªói khi ƒë·ªçc file: "+err.message,true);}
  };
  if(name.endsWith(".csv"))reader.readAsText(file,"utf-8");else reader.readAsArrayBuffer(file);
}

/* ====== Search ====== */
function doSearch(){
  const q=document.getElementById('searchBox').value.trim().toLowerCase();
  if(!sourceData.length){showMessage("Ch∆∞a c√≥ d·ªØ li·ªáu!",true);return;}
  if(!q){showMessage("√î t√¨m ki·∫øm tr·ªëng ‚Äî gi·ªØ nguy√™n d·ªØ li·ªáu hi·ªán c√≥.");return;}
  const filtered=sourceData.filter(row=>{
    // ∆∞u ti√™n SKU tr∆∞·ªõc
    if(String(row.SKU||'').toLowerCase().includes(q)) return true;
    return Object.values(row).some(v=>String(v||'').toLowerCase().includes(q));
  });
  if(filtered.length){displayedData=displayedData.concat(filtered);table.setData(displayedData);document.getElementById('table-holder').style.display='block';refreshSTT();showMessage("ƒê√£ th√™m "+filtered.length+" d√≤ng (t·ªïng: "+displayedData.length+")");}
  else showMessage("Kh√¥ng t√¨m th·∫•y SKU n√†o kh·ªõp '"+q+"'",true);
  document.getElementById('searchBox').value="";
}

/* ====== Event buttons ====== */
document.getElementById('loadFileBtn').addEventListener('click',()=>{const f=document.getElementById('fileInput').files[0];if(!f)loadFromGoogleSheet();else loadFile(f);});
document.getElementById('searchBtn').addEventListener('click',doSearch);
document.getElementById('searchBox').addEventListener('keydown',e=>{if(e.key==="Enter"){e.preventDefault();doSearch();}});
document.getElementById('addRowBtn').addEventListener('click',()=>{
  const empty={};currentColumns.forEach(k=>empty[k]='');table.addRow(empty,true).then(row=>{displayedData.push(empty);sourceData.push(empty);refreshSTT();showMessage("ƒê√£ th√™m d√≤ng m·ªõi. Nh·∫≠p d·ªØ li·ªáu v√† Enter ƒë·ªÉ l∆∞u.");});
  document.getElementById('table-holder').style.display='block';
});
document.getElementById('clearTableBtn').addEventListener('click',()=>{table.clearData();displayedData=[];showMessage("üßπ ƒê√£ x√≥a b·∫£ng. ƒêang t·∫£i l·∫°i d·ªØ li·ªáu g·ªëc...");setTimeout(loadFromGoogleSheet,600);});
document.getElementById('downloadXLSXBtn').addEventListener('click',()=>{
  displayedData=table.getData();
  if(!displayedData.length){showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i",true);return;}
  const ws=XLSX.utils.json_to_sheet(displayedData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Data");
  XLSX.writeFile(wb,"BKM_export.xlsx");
  showMessage("‚úÖ ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!");
});

/* ====== UPC Scanner ====== */
let codeReader=null;
const modal=document.getElementById('scannerModal');
const video=document.getElementById('video');
document.getElementById('scanUPCBtn').addEventListener('click',()=>{
  modal.style.display='flex';
  if(!codeReader){
    codeReader = new ZXing.BrowserMultiFormatReader();
  }
  codeReader.decodeFromVideoDevice(null, video, (result, err) => {
    if(result){
      const upc=result.text.trim();
      const found=sourceData.find(r=>r.UPC==upc || r.SKU==upc);
      if(found){
        displayedData=[found];
        table.setData(displayedData);
        refreshSTT();
        showMessage("üì¶ ƒê√£ t√¨m th·∫•y m√£: "+upc);
        const beep=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");beep.play();
      }else showMessage("‚ùå Kh√¥ng t√¨m th·∫•y m√£: "+upc,true);
    }
  });
});
document.getElementById('closeScanner').addEventListener('click',()=>{
  modal.style.display='none';
  if(codeReader) codeReader.reset();
});

/* ====== Auto load Google Sheet khi m·ªü trang ====== */
window.addEventListener('DOMContentLoaded',loadFromGoogleSheet);
</script>
</body>
</html>
