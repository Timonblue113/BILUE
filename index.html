<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra c·ª©u SKU ‚Äî Online & Offline + Scan UPC</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- ZXING Barcode Scanner -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f5f7f8;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"],input[type="file"],button,select{padding:8px;border-radius:6px;border:1px solid #ccc}
    button{background:#0ea5a4;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#64748b}
    #message{color:#334155;margin-left:8px;font-size:13px}
    #table-holder{margin-top:8px}
    @media(max-width:720px){.controls{flex-direction:column;align-items:stretch}}

    /* Vi·ªÅn xanh khi qu√©t th√†nh c√¥ng */
    #cameraView.success {
      outline: 4px solid #22c55e;
      transition: outline 0.15s ease-in-out;
    }

    /* Popup camera */
    #camera-modal{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);
      backdrop-filter:blur(3px);z-index:9999;
      justify-content:center;align-items:center;
    }
  </style>
</head>
<body>

<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div class="wrap">
  <h1>Qu·∫£n l√Ω & Tra c·ª©u SKU ‚Äî Online/Offline + Scan UPC</h1>

  <div class="controls">
    <input id="searchBox" type="text" placeholder="Nh·∫≠p SKU / T√™n h√†ng..." style="min-width:260px" />
    <button id="searchBtn" class="secondary">üîç T√¨m</button>

    <input id="barcodeBox" type="text" placeholder="Qu√©t m√£ UPC..." style="min-width:160px" />

    <select id="cameraSelect">
      <option value="">Ch·ªçn Camera‚Ä¶</option>
    </select>

    <button id="scanBtn">üì∏ Qu√©t UPC</button>

    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
    <button id="loadFileBtn">N·∫°p File</button>

    <button id="addRowBtn" class="secondary">‚ûï Th√™m d√≤ng</button>
    <button id="clearTableBtn" class="secondary">üßπ X√≥a b·∫£ng</button>
    <button id="downloadXLSXBtn">‚¨á Excel</button>

    <div id="message">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</div>
  </div>

  <div id="table-holder" style="display:none;">
    <div id="sku-table"></div>
  </div>
</div>

<!-- POPUP CAMERA -->
<div id="camera-modal">
  <div style="background:#fff;padding:10px;border-radius:10px;text-align:center;">
      <h3>üì∏ Qu√©t m√£ UPC</h3>
      <video id="cameraView" width="320" height="240" style="border-radius:6px;"></video>
      <br>
      <button id="closeCamBtn" style="margin-top:8px;">ƒê√≥ng</button>
  </div>
</div>

<script>
/* ====== X√ìA ROW ====== */
function deleteIcon(){return "<button class='del-btn'>X√≥a</button>";}
function deleteRow(e,cell){
  const row=cell.getRow();
  const idx=displayedData.indexOf(row.getData());
  if(idx>-1){displayedData.splice(idx,1);}
  row.delete();
  refreshSTT();
  showMessage("üóë ƒê√£ x√≥a 1 d√≤ng");
}

/* ====== C·ªòT ====== */
const defaultColumns=[
  {title:"STT", formatter:"rownum", width:60, hozAlign:"center"},
  {title:"üóë", formatter:deleteIcon, width:60, hozAlign:"center", headerSort:false, cellClick:deleteRow},
  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},
  {title:"UPC", field:"UPC", editor:"input"}, <!-- c·ªôt UPC -->
  {title:"Nh√£n Hi·ªáu", field:"NhanHieu", editor:"input"},
  {title:"T√™n H√†ng", field:"TenHang", editor:"input", width:260},
  {title:"M√¥ T·∫£", field:"MoTa", editor:"input", width:200},
  {title:"Quy C√°ch", field:"QuyCach", editor:"input"},
  {title:"Gi√° B√°n", field:"GiaBan", editor:"input"},
  {title:"Gi√° G·ªëc", field:"GiaGoc", editor:"input"},
  {title:"Qu√† T·∫∑ng", field:"QuaTang", editor:"input"},
  {title:"√Åp D·ª•ng", field:"ApDung", editor:"input"},
  {title:"Ng√†y Nh·∫≠p", field:"NgayNhap", editor:"input"}
];

let table=new Tabulator("#sku-table",{
  height:"520px", data:[], layout:"fitColumns",
  reactiveData:true, columns:defaultColumns
});

let sourceData=[];
let displayedData=[];

/* ====== H·ªñ TR·ª¢ ====== */
function showMessage(msg,isErr=false){
  const e=document.getElementById("message");
  e.textContent=msg;
  e.style.color=isErr?"#b91c1c":"#334155";
}
function refreshSTT(){table.redraw(true);}

/* ====== T·∫¢I GOOGLE SHEET ====== */
function setTableData(arr){
  sourceData=arr.map(r=>({...r}));
  table.setData(sourceData);
  displayedData=[];
  document.getElementById("table-holder").style.display="block";
  showMessage("‚úÖ ƒê√£ t·∫£i "+arr.length+" d√≤ng!");
}
function loadFromGoogleSheet(){
  const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pub?output=csv";
  fetch(url).then(r=>r.text()).then(txt=>{
    const wb=XLSX.read(txt,{type:"string"});
    setTableData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""}));
  });
}

/* ====== T√åM ∆ØU TI√äN SKU ‚Üí UPC ‚Üí TO√ÄN B·∫¢NG ====== */
function searchByCode(code){
  const c=String(code).trim();

  let f = sourceData.filter(r=>String(r.SKU||"").trim()===c);
  if(!f.length) f = sourceData.filter(r=>String(r.UPC||"").trim()===c);
  if(!f.length) f = sourceData.filter(r=>Object.values(r).some(v=>String(v||"").trim()===c));

  if(f.length){
    displayedData = displayedData.concat(f);
    table.setData(displayedData);
    refreshSTT();
    showMessage("üîç T√¨m th·∫•y "+f.length+" d√≤ng");
    document.getElementById("beepSound").play().catch(()=>{});
  }else{
    showMessage("‚ùå Kh√¥ng t√¨m th·∫•y m√£ "+c,true);
  }
}

/* ====== NH·∫¨P UPC = AUTO T√åM ====== */
document.getElementById("barcodeBox").addEventListener("input", e=>{
  const v=e.target.value.replace(/\D/g,"");
  e.target.value=v;
  if(v.length===7 || v.length===12 || v.length===13){
    searchByCode(v);
    e.target.value="";
  }
});

/* ====== T√åM TH∆Ø·ªúNG ====== */
document.getElementById("searchBtn").addEventListener("click",()=>{
  const q=document.getElementById("searchBox").value.trim().toLowerCase();
  if(!q) return;
  const f=sourceData.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q)));
  displayedData=f;
  table.setData(displayedData);
  refreshSTT();
  showMessage("üîé "+f.length+" k·∫øt qu·∫£");
});

/* ====== CAMERA ====== */
let codeReader=new ZXing.BrowserMultiFormatReader();
let selectedDevice="";
let scanning=false;

ZXing.BrowserMultiFormatReader.listVideoInputDevices().then(dev=>{
  const sel=document.getElementById("cameraSelect");
  dev.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.deviceId;
    o.textContent=d.label||("Camera "+sel.length);
    sel.appendChild(o);
  });
});

document.getElementById("cameraSelect").addEventListener("change", e=>{
  selectedDevice=e.target.value;
  if(scanning){stopScan(); startScan();}
});

document.getElementById("scanBtn").addEventListener("click", ()=>{
  document.getElementById("camera-modal").style.display="flex";
  startScan();
});

function startScan(){
  scanning=true;
  const video=document.getElementById("cameraView");

  codeReader.decodeFromVideoDevice(selectedDevice, video,(result,err)=>{
    if(result){
      const code=result.text.trim();

      video.classList.add("success");
      setTimeout(()=>video.classList.remove("success"),150);

      document.getElementById("beepSound").play().catch(()=>{});

      searchByCode(code);
    }
  });
}

document.getElementById("closeCamBtn").addEventListener("click", stopScan);

function stopScan(){
  scanning=false;
  codeReader.reset();
  document.getElementById("camera-modal").style.display="none";
}

/* ====== LOAD SHEET ====== */
window.addEventListener("DOMContentLoaded",loadFromGoogleSheet);
</script>
</body>
</html>
