<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra c·ª©u SKU ‚Äî Offline (n·∫°p Excel)</title>

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; background:#f5f7f8; margin:0; padding:18px}
    .wrap{max-width:1200px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0;font-size:20px;color:#0f766e}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"], input[type="file"], button {padding:8px;border-radius:6px;border:1px solid #ccc}
    button {background:#0ea5a4;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#64748b}
    #message{color:#334155;margin-left:8px;font-size:13px}
    #table-holder{margin-top:8px}
    @media(max-width:720px){ .controls{flex-direction:column;align-items:stretch} }
    .hint{font-size:13px;color:#566574;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Qu·∫£n l√Ω & Tra c·ª©u SKU ‚Äî Offline</h1>

    <div class="controls">
      <input id="searchBox" type="text" placeholder="Nh·∫≠p SKU / T√™n h√†ng / Nh√£n hi·ªáu..." style="min-width:300px" />
      <button id="searchBtn" class="secondary">üîç T√¨m ki·∫øm</button>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <button id="loadFileBtn">N·∫°p file</button>
      <button id="addRowBtn" class="secondary">‚ûï Th√™m d√≤ng</button>
      <button id="downloadCSVBtn">‚¨á T·∫£i v·ªÅ CSV</button>
      <div id="message">M·ªü l·∫ßn ƒë·∫ßu c·∫ßn Internet ƒë·ªÉ t·∫£i th∆∞ vi·ªán, sau ƒë√≥ c√≥ th·ªÉ d√πng offline.</div>
    </div>

    <div class="hint">1) N·∫°p file ‚Üí 2) Nh·∫≠p t·ª´ kh√≥a & Enter ƒë·ªÉ t√¨m (c·ªông d·ªìn) ‚Üí 3) S·ª≠a ho·∫∑c th√™m d√≤ng tr·ª±c ti·∫øp.</div>

    <div id="table-holder" style="margin-top:12px; display:none;">
      <div id="sku-table"></div>
    </div>
  </div>

<script>
/* ====== C·∫•u h√¨nh c·ªôt m·∫∑c ƒë·ªãnh ====== */
const defaultColumns = [
  {title:"NH", field:"NH", editor:"input", width:70},
  {title:"SKU", field:"SKU", editor:"input"},
  {title:"Nh√£n Hi·ªáu", field:"NhanHieu", editor:"input"},
  {title:"T√™n H√†ng", field:"TenHang", editor:"input", width:300},
  {title:"M√¥ T·∫£", field:"MoTa", editor:"input", width:250},
  {title:"Quy C√°ch", field:"QuyCach", editor:"input"},
  {title:"Gi√° B√°n", field:"GiaBan", editor:"input"},
  {title:"Gi√° G·ªëc", field:"GiaGoc", editor:"input"},
  {title:"Qu√† T·∫∑ng", field:"QuaTang", editor:"input"},
  {title:"√Åp D·ª•ng", field:"ApDung", editor:"input"},
  {title:"Ng√†y Nh·∫≠p", field:"NgayNhap", editor:"input"}
];

let table = new Tabulator("#sku-table", {
  height:"520px",
  data:[],
  layout:"fitColumns",
  reactiveData:true,
  columns: defaultColumns,
  placeholder:"Ch∆∞a n·∫°p d·ªØ li·ªáu. B·∫•m N·∫°p file ƒë·ªÉ ch·ªçn Excel/CSV",
  cellEdited:()=> sourceData = table.getData(),
});

let sourceData = [];
let currentColumns = defaultColumns.map(c=>c.field);
let displayedData = []; // d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (ƒë·ªÉ c·ªông d·ªìn)

/* ====== X·ª≠ l√Ω file ====== */
function normalizeKey(k){ return String(k||'').trim(); }
function setTableColumnsFromKeys(keys){
  const cols = keys.map(k=>({title:k, field:k, editor:"input"}));
  table.setColumns(cols);
  currentColumns = keys.slice();
}

function setTableData(arr){
  sourceData = arr.map(r=>{
    const out = {};
    Object.keys(r).forEach(k=>{
      out[normalizeKey(k)] = r[k]===null || r[k]===undefined ? '' : String(r[k]);
    });
    return out;
  });
  const keys = sourceData.length ? Object.keys(sourceData[0]) : currentColumns;
  setTableColumnsFromKeys(keys);
  table.clearData();
  displayedData = [];
  document.getElementById('table-holder').style.display = 'none';
  showMessage("ƒê√£ n·∫°p d·ªØ li·ªáu: " + arr.length + " d√≤ng. Nh·∫≠p t·ª´ kh√≥a & Enter ƒë·ªÉ t√¨m (c·ªông d·ªìn).");
}

function arrayBufferToWorkbook(ab){ return XLSX.read(ab, {type:"array"}); }
function workbookToJson(wb){
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  return XLSX.utils.sheet_to_json(ws, {defval:""});
}
function parseCsvText(text){
  const wb = XLSX.read(text, {type:"string"});
  return workbookToJson(wb);
}
function loadFile(file){
  const reader = new FileReader();
  const name = (file.name||'').toLowerCase();
  reader.onload = function(e){
    try{
      let arr;
      if(name.endsWith(".csv")){
        arr = parseCsvText(e.target.result);
      } else {
        const wb = arrayBufferToWorkbook(e.target.result);
        arr = workbookToJson(wb);
      }
      setTableData(arr);
    }catch(err){
      console.error(err);
      showMessage("L·ªói khi ƒë·ªçc file: " + err.message, true);
    }
  };
  if(name.endsWith(".csv")) reader.readAsText(file, "utf-8");
  else reader.readAsArrayBuffer(file);
}

/* ====== T√¨m ki·∫øm (c·ªông d·ªìn) ====== */
function normalizeVal(v){ return String(v||'').toLowerCase(); }

function doSearch(){
  const q = document.getElementById('searchBox').value.trim().toLowerCase();
  if(!sourceData.length){ showMessage("Ch∆∞a c√≥ d·ªØ li·ªáu! H√£y n·∫°p file tr∆∞·ªõc.", true); return; }
  if(!q){ 
    showMessage("√î t√¨m ki·∫øm tr·ªëng ‚Äî gi·ªØ nguy√™n d·ªØ li·ªáu hi·ªán c√≥."); 
    return; 
  }

  const filtered = sourceData.filter(row =>
    Object.values(row).some(v => normalizeVal(v).includes(q))
  );

  if(filtered.length){
    // C·ªông d·ªìn: th√™m c√°c d√≤ng ch∆∞a c√≥ SKU tr√πng
    const currentSkus = new Set(displayedData.map(r => r.SKU));
    const newRows = filtered.filter(r => !currentSkus.has(r.SKU));
    displayedData = displayedData.concat(newRows);
    table.setData(displayedData);
    document.getElementById('table-holder').style.display = 'block';
    showMessage("ƒê√£ th√™m " + newRows.length + " d√≤ng (t·ªïng: " + displayedData.length + ")");
  }else{
    showMessage("Kh√¥ng t√¨m th·∫•y SKU n√†o kh·ªõp '" + q + "'", true);
  }
  document.getElementById('searchBox').value = ""; // t·ª± clear √¥ t√¨m ki·∫øm
}

document.getElementById('searchBtn').addEventListener('click', doSearch);
document.getElementById('searchBox').addEventListener('keydown', function(e){
  if(e.key === "Enter"){ e.preventDefault(); doSearch(); }
});

/* ====== Th√™m d√≤ng ====== */
document.getElementById('addRowBtn').addEventListener('click', function(){
  const empty = {};
  (currentColumns.length ? currentColumns : defaultColumns.map(c=>c.field)).forEach(k=> empty[k]='');
  table.addRow(empty, true).then((row)=>{
    displayedData.push(empty);
    sourceData.push(empty);
    showMessage("ƒê√£ th√™m d√≤ng m·ªõi. Nh·∫≠p d·ªØ li·ªáu v√† Enter ƒë·ªÉ l∆∞u.");
    const firstCell = row.getCell(currentColumns[0]);
    if(firstCell){ firstCell.edit(true); }
  });
  document.getElementById('table-holder').style.display = 'block';
});

/* ====== Xu·∫•t CSV ====== */
function downloadCurrentCSV(filename = "BKM_export.csv"){
  if(!displayedData.length){ showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i", true); return; }
  const keys = Object.keys(displayedData[0]);
  const rows = [keys.join(",")].concat(displayedData.map(r => keys.map(k => '"' + (String(r[k]||'')).replace(/"/g,'""') + '"').join(",")));
  const csv = rows.join("\n");
  const bom = "\uFEFF"; // th√™m BOM UTF-8 ƒë·ªÉ Excel nh·∫≠n ƒë√∫ng font
  const blob = new Blob([bom + csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showMessage("ƒê√£ xu·∫•t CSV: " + filename);
}

/* ====== N√∫t n·∫°p/t·∫£i ====== */
document.getElementById('loadFileBtn').addEventListener('click', function(){
  const f = document.getElementById('fileInput').files[0];
  if(!f){ showMessage("Vui l√≤ng ch·ªçn file tr∆∞·ªõc khi b·∫•m N·∫°p file", true); return; }
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8IaOB5nDtf4HFkXO-eldwQbG81Rt1cTEkYURUCFsNiZjzuLxCG_b731-Q9LLmnpwpEkQaCxOAkCR/pubhtml?gid=623088832&single=true")
  .then(r=>r.text())
  .then(txt=>{
    const arr = parseCsvText(txt);
    setTableData(arr);
    showMessage("ƒê√£ n·∫°p d·ªØ li·ªáu online t·ª´ Google Sheets (" + arr.length + " d√≤ng)");
  });

});
document.getElementById('fileInput').addEventListener('change', function(){
  const f = this.files[0];
  if(f) showMessage("File ƒë√£ ch·ªçn: " + f.name);
});
document.getElementById('downloadCSVBtn').addEventListener('click', function(){
  displayedData = table.getData();
  downloadCurrentCSV();
});

/* ====== Th√¥ng b√°o ====== */
function showMessage(msg, isError=false){
  const el = document.getElementById('message');
  el.textContent = msg;
  el.style.color = isError ? "#b91c1c" : "#334155";
}
</script>
</body>
</html>
